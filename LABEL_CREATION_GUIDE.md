# BB 反彈標籤創建指南

## 核心邏輯

### 第 1 層：識別觸碰點

```
K 棒觸碰下軌或上軌 (有可配置的閾值)
┌─ 下軌觸碰 (low 接近 lower_band)
│  └─ 距離 < threshold% × BB_width
└─ 上軌觸碰 (high 接近 upper_band)
   └─ 距離 < threshold% × BB_width
```

### 第 2 層：判斷後續反彈

```
在觸碰點後檢查後續 N 根 K 棒
┌─ 下軌觸碰 → 檢查是否有上漲
│  └─ 最高價 - 觸碰價 >= min_rebound_pct
└─ 上軌觸碰 → 檢查是否有下跌
   └─ 觸碰價 - 最低價 >= min_rebound_pct
```

### 第 3 層：標籤定義

```
標籤：
1  = 觸碰下軌 + 有上漲反彈 ✓
0  = 觸碰下軌 + 無上漲反彈 ✗
2  = 觸碰上軌 + 有下跌反彈 ✓
-1 = 無觸碰 (忽略)
```

### 第 4 層：驗證準確率

```
在有效反彈點進行回測
┌─ 下軌做多 (label=1)
│  └─ 5根K棒後價格 > 進場價 → 準確
└─ 上軌做空 (label=2)
   └─ 5根K棒後價格 < 進場價 → 準確
```

---

## 參數調解

### `touch_threshold` (觸碰閾值)

```
定義：K 棒到 BB 軌道的最大距離
單位：BB 寬度的百分比
範圍：0.02 ~ 0.2 (2% ~ 20%)

示例：
- touch_threshold = 0.05 (5%)
  └─ 只標記 low 到 lower_band 距離 < 5% BB寬度的 K 棒
  
建議：
- 0.02：非常嚴格，觸碰點少 (~1-2%)
- 0.05：中等嚴格，平衡點 (推薦起點)
- 0.1：寬鬆，觸碰點多 (~5-10%)
```

### `lookahead` (後續驗證週期)

```
定義：觸碰點後檢查多少根 K 棒
單位：K 棒數
範圍：3 ~ 10

示例：
- lookahead = 5
  └─ 在觸碰點後的 5 根 K 棒內檢查反彈

建議：
- 3：短期反彈
- 5：中期反彈 (推薦起點，對應 15m = 75分鐘)
- 7：較長期反彈
- 10：長期反彈
```

### `min_rebound_pct` (最小反彈幅度)

```
定義：觸碰點後的最小反彈百分比
單位：百分比 (%)
範圍：0.05 ~ 0.2

示例：
- min_rebound_pct = 0.1 (0.1%)
  └─ 價格必須反彈至少 0.1% 才算有效

建議：
- 0.05：非常敏感，容易標記為有效
- 0.1：平衡點 (推薦起點)
- 0.15：較嚴格
- 0.2：非常嚴格，只捕捉強反彈
```

---

## 調試策略

### 情景 1：準確率 < 85%

```
問題：標籤定義過於寬鬆，太多假反彈

解決方案：
1. 增加 min_rebound_pct (0.1 → 0.15 → 0.2)
   └─ 只標記明顯的反彈
   
2. 減少 lookahead (5 → 3)
   └─ 縮短驗證窗口，要求反彈更快出現
   
3. 減少 touch_threshold (0.1 → 0.05)
   └─ 只標記真正接近軌道的觸碰
```

### 情景 2：觸碰點太少 (< 500)

```
問題：標籤定義過於嚴格，遺漏了很多機會

解決方案：
1. 增加 touch_threshold (0.05 → 0.1)
   └─ 標記更多接近軌道的觸碰
   
2. 增加 lookahead (5 → 7)
   └─ 給更多時間出現反彈
   
3. 減少 min_rebound_pct (0.1 → 0.05)
   └─ 允許更小的反彈
```

### 情景 3：準確率很高但樣本少

```
問題：標籤質量好但數量不足

解決方案：
在保持 >95% 準確率前提下：
1. 微調 touch_threshold (增加 5-10%)
2. 或微調 lookahead (增加 1-2)
3. 或微調 min_rebound_pct (減少 0.05)
```

---

## 調參工作流程

### 第 1 次循環

```python
# 使用推薦參數
bb_period=20
bb_std=2
touch_threshold=0.05      # 中等
lookahead=5               # 中期
min_rebound_pct=0.1       # 平衡
```

結果檢查：
```
觸碰點 > 1,000?  是 ✓ / 否 ✗
有效反彈 > 500?  是 ✓ / 否 ✗
準確率 > 85%?    是 ✓ / 否 ✗
```

### 第 2 次循環

根據第 1 次結果調整：

**如果準確率 < 80%**
```python
touch_threshold = 0.05    # 保持
lookahead = 5             # 保持
min_rebound_pct = 0.15    # ↑ 增加
```

**如果觸碰點 < 500**
```python
touch_threshold = 0.1     # ↑ 增加
lookahead = 5             # 保持
min_rebound_pct = 0.1     # 保持
```

### 第 3 次循環

微調以達到最優：
- 準確率 > 95%
- 觸碰點 > 1,000
- 有效反彈 > 500

---

## 統計分析

### 有效反彈特徵

```
系統會輸出：
有效反彈統計 (n=2,150)：
  平均幅度：0.2341%
  中位幅度：0.1850%
  最大幅度：2.3450%
  最小幅度：0.1001%
  標準差：0.0834%
```

### 無效反彈特徵

```
無效反彈統計 (n=3,000)：
  平均幅度：0.0512%
  中位幅度：0.0245%
  最大幅度：0.0999%
  最小幅度：0.0000%
  標準差：0.0321%
```

### 對比分析

```
關鍵指標：
- 有效反彈平均 / 無效反彈平均 = 4.57×
- 說明有效反彈明顯更強
- 這是好的標籤信號
```

---

## 常見問題

### Q: 為什麼有效反彈比例只有 46%?
A: 正常的！不是所有觸碰都會反彈。這反映市場真實情況。

### Q: 能否達到 99% 準確率?
A: 可以，但需要平衡樣本量。太嚴格的標籤質量高但數量少。

### Q: 應該用 15m 還是 1h 的數據?
A: 兩者都可以。試試看哪個準確率更高。

### Q: 如何驗證標籤質量?
A: 在有效反彈點做交易，檢查實際盈虧率。應該 > 85%。

---

## 技術細節

### 觸碰檢測算法

```python
# 計算 K 棒到軌道的距離
dist_to_lower = (close - lower_band) / bb_width

# 觸碰判定
if dist_to_lower < touch_threshold:
    mark_as_touch('lower')
```

### 反彈驗證算法

```python
# 下軌反彈
future_prices = prices[i+1:i+lookahead+1]
max_price = future_prices.max()
rebound_pct = (max_price - touch_price) / touch_price * 100

if rebound_pct >= min_rebound_pct:
    label = 1  # 有效
else:
    label = 0  # 無效
```

### 準確率計算

```python
# 回測：在有效反彈點進行交易
correct = 0
for each_valid_signal:
    entry = touch_price
    close = price_after_lookahead_bars
    
    if close > entry:  # (下軌做多)
        correct += 1

accuracy = correct / total_valid_signals * 100
```

---

## 最佳實踐

1. **從推薦參數開始**
   - 不要隨意調整
   - 每次只改一個參數

2. **查看日誌**
   - 檢查統計數據
   - 驗證算法邏輯

3. **記錄每次結果**
   - 保存 `parameter_tuning_results.json`
   - 對比參數效果

4. **手動驗證樣本**
   - 隨機選擇 10 個標籤點
   - 在圖表上視覺檢查
   - 確保邏輯正確

---

**目標：達到 99% 的標籤準確率，為 ML 模型提供最優質的訓練數據。**
