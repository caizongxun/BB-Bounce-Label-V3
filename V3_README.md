# BB-Bounce Label V3 - 完全重新設計版本

## 概述

V3 版本是對整個訓練系統的完全重新設計。核心改進包括：

### 1. 進階標籤生成 (AdvancedLabelGenerator)

**邏輯**:
```
[觸碰下軌] → 檢查未來 N 根 K 棒 → 計算最高點利潤 → 加權調整
```

**特點**:
- 識別確實觸碰下軌的點（而非接近）
- 計算未來 5 根 K 棒的真實獲利潛力
- 根據 ATR（波幅）加權調整利潤閾值
  - 波幅大 → 要求更高的絕對利潤
  - 波幅小 → 相對較低的利潤也算
- 避免極端情況（崩盤前的觸碰）

**參數**:
```python
bb_period=20          # 布林傑帶周期
bb_std=2             # 標準差倍數
lookforward=5        # 未來檢查根數
profit_threshold=0.001  # 基礎利潤閾值 (0.1%)
```

### 2. 多層特徵工程 (AdvancedFeatureEngineer)

#### Layer 1: 技術指標（Momentum）
- **RSI (14)** - 相對強弱指標，識別超買/超賣
- **MACD** - 動量收斂發散，動量和趨勢信號
- **Stochastic Oscillator** - 隨機指標，價格動量
- **ROC (10)** - 變化率，動量強度

#### Layer 2: 波動率指標（Volatility）
- **ATR (14)** - 平均真實波幅，市場波動性
- **Historical Volatility (20)** - 歷史波動率
- **Bollinger Bands Position** - 布林傑帶位置 (0-1 正規化)
- **Volatility Ratio** - 當前波動相對歷史平均

#### Layer 3: 趨勢指標（Trend）
- **EMA (12, 26)** - 指數加權移動平均線
- **SMA (20, 50)** - 簡單移動平均線
- **Price/SMA Ratio** - 價格相對於均線的位置

#### Layer 4: 成交量指標（Volume）
- **OBV** - 能量指標
- **Volume Ratio** - 當前成交量相對平均

#### Layer 5: K 棒形態（Candle Pattern）
- **Body Size** - K 棒實體大小
- **Upper/Lower Wick** - 上下影線
- **True Range Ratio** - 真實波幅比
- **Direction** - 漲/跌方向

#### Layer 6: 統計特徵（Statistical）
- **Returns Skewness** - 收益率偏度（價格傾向）
- **Returns Kurtosis** - 收益率峰度（尾部厚度）
- **Price Acceleration** - 價格加速度

#### Layer 7: 滯後特徵（Lag Features）
- 前 1, 2, 3, 5 根 K 棒的關鍵指標
- 捕捉短期趨勢和動量

#### Layer 8: 交互特徵（Interaction）
- RSI × ATR - 相對強度與波動性的組合
- MACD / ATR - 動量標準化

**總特徵數**: 45+ 維度

### 3. 優化的模型選擇

#### XGBoost (推薦)
**為什麼選擇 XGBoost**:
- 處理非線性關係效果好
- 自動處理特徵交互
- 對小樣本數據穩定性強
- 提供特徵重要性排名

**超參數**:
```python
n_estimators=200      # 樹數量
max_depth=6          # 樹深度
learning_rate=0.05   # 學習率
subsample=0.8        # 行採樣
colsample_bytree=0.8 # 列採樣
scale_pos_weight     # 自動計算不平衡權重
```

#### Random Forest (對比)
用於驗證結果的一致性和穩定性

### 4. 關鍵改進 vs V2

| 方面 | V2 | V3 | 改進 |
|------|----|----|------|
| 特徵數 | 31 | 45+ | +45% |
| 標籤邏輯 | 簡單比較 | ATR 加權 | ✅ 更合理 |
| 特徵層數 | 2 層 | 8 層 | ✅ 更全面 |
| Lag 特徵 | 無 | 4 個lag | ✅ 捕捉趨勢 |
| 交互特徵 | 1 個 | 多個 | ✅ 非線性 |
| 模型選擇 | 固定 | 對比評估 | ✅ 更科學 |
| AUC-ROC | 68.04% | TBD | 預期 72%+ |

## 使用方法

### 安裝依賴
```bash
pip install pandas numpy scikit-learn xgboost talib-ng matplotlib
```

### 運行訓練
```bash
# 清理舊檔案
python cleanup.py

# 運行 V3 訓練
python feature_engineering_and_training_v3_final.py
```

### 輸出結果

訓練完成後會生成：
- `outputs/models/BTCUSDT_15m_model_v3.pkl` - 訓練好的模型
- `outputs/models/BTCUSDT_15m_scaler_v3.pkl` - 標準化器

### 日誌輸出示例
```
======================================================================
特徵工程 + 模型訓練 V3 (完全重新設計)
======================================================================

第 2 階段：進階標籤生成
======================================================================
觸碰下軌點數: 5234
其中盈利: 4521 (86.4%)

第 3 階段：多層特徵工程
======================================================================
計算動量指標...
計算波動率指標...
計算趨勢指標...
計算成交量指標...
計算 K 棒形態...
計算統計特徵...
計算滯後特徵 (lags=[1, 2, 3, 5])...
計算交互特徵...
特徵工程完成！總特徵數: 48

第 4 階段：模型訓練與評估
======================================================================
準備訓練數據...
有效樣本數: 51000
  正樣本 (label=1): 43000
  負樣本 (label=0): 8000

訓練集: 40800 | 測試集: 10200

訓練 XGBoost 模型...
訓練 Random Forest 模型...

XGBoost 測試集性能:
  Accuracy:  0.8421
  Precision: 0.8535
  Recall:    0.9876
  F1 Score:  0.9168
  AUC-ROC:   0.7342
  混淆矩陣: TN=45, FP=1200, FN=98, TP=8857

Random Forest 測試集性能:
  Accuracy:  0.8234
  Precision: 0.8312
  Recall:    0.9654
  F1 Score:  0.8956
  AUC-ROC:   0.6984

最佳模型: XGBoost (AUC-ROC: 0.7342)

XGBoost 前 15 個重要特徵:
 1. BB_Position              - 0.0892
 2. ATR                      - 0.0654
 3. Historical_Vol           - 0.0598
 4. EMA_Diff                 - 0.0487
 5. RSI_Lag1                 - 0.0456
 ...
```

## 設計思想

### 為什麼去掉布林傑帶通道過濾？

在 V2 中，布林傑帶通道被用作「特徵」。在 V3 中：
1. **BB_Position** 作為歸一化特徵保留（更乾淨）
2. **多層特徵** 讓模型自己學習哪些組合最有效
3. **不依賴單一指標** - 模型從 45+ 個角度理解市場

### 為什麼使用 ATR 加權？

```
Situation A: 平靜市場 (ATR = 50)
觸碰下軌後上漲 100 點 (0.2%) → 這是高品質信號 ✅

Situation B: 波動市場 (ATR = 150)
觸碰下軌後上漲 100 點 (0.2%) → 相對於波動，信號弱 ⚠️
調整閾值至 150 × 0.001 = 0.15% 要求 → 更合理
```

### 為什麼需要滯後特徵？

交易信號不是孤立的。前 1-5 根 K 棒的狀態幫助模型判斷：
- 趨勢是否強於 / 弱於平時
- 是否已經有反彈跡象
- 歷史動量方向

## 預期改進

### V2 → V3 對比

```
維度       V2      →    V3      改進
────────────────────────────────
特徵數     31     →    48      +55%
AUC-ROC   68.0%  →   72%+     +4-6%
Recall    99.8%  →   95%      更平衡
Precision 81.8%  →   85%+     更精準
F1 Score  89.9%  →   91%+     整體更好
```

## 下一步優化方向

1. **ensemble 模型** - XGBoost + LSTM 混合
2. **動態閾值** - 根據市場狀態自適應
3. **回測驗證** - 實際交易績效測試
4. **特徵選擇** - 移除低重要性特徵
5. **時間序列交叉驗證** - 避免數據洩露

## 常見問題

**Q: 為什麼 AUC-ROC 沒有達到 90%？**
A: 市場是隨機的，沒有完美的訊號。80-85% 的 AUC 已經表現優異。更高的指標可能過擬合。

**Q: 需要多少數據？**
A: 最少 5000 條觸碰記錄。越多越好（>50000 最佳）。

**Q: 能否用在其他幣種？**
A: 可以。只需準備相同格式的標籤數據即可。

---

**版本**: V3 Final  
**最後更新**: 2026-01-04  
**維護人**: AI 系統
